$(function() {
  var center = new google.maps.LatLng(41.88, -87.67);
  var zoomLevel = 12;
  var mapOptions = {
    center: center,
    mapTypeControl: true,
    mapTypeId: google.maps.MapTypeId.HYBRID,
    panControl: true,
    zoom: zoomLevel
  };
  
  var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  var isWindowOpen = false;
  var activeObjectId;
  var activeMarker;
  var activeInfoWindow = new google.maps.InfoWindow({
    maxWidth: 350
  });

  //code to initialize OhSoWe widget
  //initialize widget
  widget = new OhSoWe.MapWidget({
    version: "0.1",
    partnerId: "snowflake",
    container: "osw_widget"
  }).render();
  console.debug('OhSoWe Widget initialized');
  
  //set the google maps listener
  google.maps.event.addListener(map, 'bounds_changed', function() {
    console.debug('bounds_changed');
    widget.boundsChanged(map.getBounds().toUrlValue());
  });

  
  bindInfoWindowLink( 'adopt_link', '/map_objects', 'POST', {}, {showIW: false} );
  bindInfoWindowLink( 'sign_in_link', '/users/sign_in', 'GET', {}, {showIW: false} );
  bindInfoWindowLink( 'sign_up_link', '/users/sign_up', 'GET', {}, {showIW: false} );
  
  google.maps.event.addListener(activeInfoWindow, 'closeclick', function() {
    isWindowOpen = false;
  });
  
  function renderKML(lat, lng) {
    console.log("Rendering sidewalks of [%s, %s]", lat, lng);
    var url = 'http://167.165.233.18/sidewalks.kml?lat=' + lat + '&lng=' + lng;
    var sidewalks_kml = new google.maps.KmlLayer(url, {suppressInfoWindows: true, map: map});

    google.maps.event.addListener(sidewalks_kml, 'click', function(e) {
      isWindowOpen = true;
      activeObjectId = e.featureData.description;
      console.log("Fetched KML: %s", JSON.stringify(e.featureData));
      fetchSidewalkInfo(e);
    });
  }

  function fetchSidewalkInfo(e) {
    $.ajax({
      type: 'GET',
      url: '/map_objects/' + activeObjectId,
      data: {
        //'id': activeObjectId
      },
      beforeSend: function() {
        hideInfoWindow();
        showSpinner();
      },
      error: function(jqXHR) {
        hideSpinner();
        showInfoWindow;
      },
      success: function(data) {
        activeInfoWindow.setOptions({
          content: data,
          position: e.latLng,
          pixelOffset: e.pixelOffset
        });
        activeInfoWindow.open(map);
        showInfoWindow();
      }
    });
  }
  
  function showInfoWindow() {
    $('#info_window').show();
  }
  
  function hideInfoWindow() {
    $('#info_window').hide();
  }
  
  function showSpinner() {
    $('#spinner').show();
  }
  
  function hideSpinner() {
    $('#spinner').hide();
  }
  
  google.maps.event.addListener(map, 'dragend', function() {
    if(isWindowOpen == true) {
      return;
    }
    var new_center = map.getCenter();
    renderKML(new_center.lat(), new_center.lng());
  });
  
  $('#address_form').submit(function() {
    var submitButton = $("input[type='submit']", this);
    $(submitButton).attr("disabled", true);
    if($('#address').val() === '') {
      $(submitButton).attr("disabled", false);
      $('#address_label').addClass('error', 500);
      $('#address').addClass('error', 500);
      $('#address').focus();
    } else {
      $.ajax({
        type: 'GET',
        url: '/address.json',
        data: {
          'commit': submitButton.val(),
          'utf8': '✓',
          'city_state': $('#city_state').val(),
          'address': $('#address').val()
        },
        success: function(data) {
          console.log("returned address data: %o", data)
          $(submitButton).attr("disabled", false);
          if(data.errors) {
            $('#address_label').addClass('error', 500);
            $('#address').addClass('error', 500);
            $('#address').focus();
          } else {
            map.setCenter(new google.maps.LatLng(data[0], data[1]));
            renderKML(data[0], data[1]);
          }
        }
      });
    }
    return false;
  });
  
  




  $('#sign_up_form').live('submit', function() {
    var submitButton = $("input[type='submit']", this);
    var uemail = $('#user_email');
    var ufname = $('#user_first_name');
    var ulname = $('#user_last_name');
    var upwd = $('#user_password');
    var errors = [];
    
    $(submitButton).attr("disabled", true);
    if(!/[\w\.%\+\]+@[\w\]+\.+[\w]{2,}/.test(uemail.val())) {
      markError(uemail, errors);
    } else {
      unmarkError(uemail);
    }
    if(ufname.val() === '') {
      markError(ufname, errors);
    } else {
      unmarkError(ufname);
    }
    if(ulname.val() === '') {
      markError(ulname, errors);
    } else {
      unmarkError(ulname);
    }
    if(upwd.val().length < 6 || upwd.val().length > 20) {
      markError(upwd, errors);
    } else {
      unmarkError(upwd);
    }
    if(errors.length > 0) {
      $(submitButton).attr("disabled", false);
      errors[0].focus();
    } else {
      $.ajax({
        type: 'POST',
        url: '/users.json',
        data: {
          'commit': submitButton.val(),
          'utf8': '✓',
          'authenticity_token': $('input[name="authenticity_token"]', this).val(),
          'user': {
            'email': uemail.val(),
            'first_name': ufname.val(),
            'last_name': ulname.val(),
            //'organization': $('#user_organization').val(),
            'password': upwd.val()
          }
        },
        beforeSend: function() {
          hideInfoWindow();
          showSpinner();
        },
        error: function(jqXHR) {
          data = $.parseJSON(jqXHR.responseText);
          hideSpinner();
          showInfoWindow();
          $(submitButton).attr("disabled", false);
          
          if(data.errors.email) {
            markError(uemail, errors);
          }
          if(data.errors.fname) {
            markError(ufname, errors);
          }
          if(data.errors.lname) {
            markError(ulname, errors);
          }
          if(data.errors.organization) {
          }
          if(data.errors.password) {
            markError(upwd, errors);
          }
          errors[0].focus();
        },
        success: function(data) {
          activeInfoWindow.setContent(data);
          //$.ajax({
          //  type: 'GET',
          //  url: '/info_window',
          //  data: {
          //    'thing_id': activeObjectId,
          //    'flash': {
          //      'notice': "<%= I18n.t("notices.signed_up") %>"
          //    }
          //  },
          //  success: function(data) {
          //    activeInfoWindow.setContent(data);
          //  }
          //});
        }
      });
    }
    return false;
  });
    
  $('#sign_in_form').live('submit', function() {
    var submitButton = $("input[type='submit']", this);
    var uemail = $('#user_email');
    var upwd = $('#user_password');
    var errors = [];

    if(!/[\w\.%\+\]+@[\w\]+\.+[\w]{2,}/.test(uemail.val())) {
      markError(uemail, errors);
    } else {
      unmarkError(uemail);
    }
    if(upwd.val().length < 6 || upwd.val().length > 20) {
      markError(upwd, errors);
    } else {
      unmarkError(upwd);
    }
    if(errors.length > 0) {
      $(submitButton).attr("disabled", false);
      errors[0].focus();
    } else {
      console.debug("here works");
      $.ajax({
        type: 'POST',
        url: '/users/sign_in.json',
        data: {
          'commit': submitButton.val(),
          'utf8': '✓',
          'authenticity_token': $('input[name="authenticity_token"]', this).val(),
          'user': {
            'email': uemail.val(),
            'password': upwd.val(),
            'remember_me': $('#user_remember_me').val()
          }
        },
        beforeSend: function() {
          hideInfoWindow();
          showSpinner();
        },
        error: function(jqXHR) {
          hideSpinner();
          showInfoWindow();
          $(submitButton).attr("disabled", false);
          markError(upwd, errors);
          upwd.focus();
        },
        success: function(data) {
          console.debug("works 2");
          //$.ajax({
          //  type: 'GET',
          //  url: '/info_window',
          //  data: {
          //    'thing_id': activeObjectId,
          //    'flash': {
          //      'notice': "<%= I18n.t("notices.signed_in") %>"
          //    }
          //  },
          //  success: function(data) {
          //    activeInfoWindow.setContent(data);
          //  }
          //});
        }
      });
    }
    return false;
  });
    
    
    
    
    
    
  $('#user_forgot_password_link').live('submit', function() {
    var submitButton = $("input[type='submit']", this);

    if(errors.length > 0) {
      $(submitButton).attr("disabled", false);
      errors[0].focus();
    } else {
      $.ajax({
        type: 'POST',
        url: '/users/password.json',
        data: {
          'commit': submitButton.val(),
          'utf8': '✓',
          'authenticity_token': $('input[name="authenticity_token"]', this).val(),
          'user': {
            'email': $('#user_email').val()
          }
        },
        beforeSend: function() {
          $('#info_window').hide();
          $('#loader').show();
        },
        error: function(jqXHR) {
          $('#loader').hide();
          $('#info_window').show();
          $(submitButton).attr("disabled", false);
          $('#user_email_label').addClass('error', 500);
          $('#user_email').addClass('error', 500);
          $('#user_email').focus();
        },
        success: function() {
          $.ajax({
            type: 'GET',
            url: '/users/sign_in',
            data: {
              'user': {
                'email': $('#user_email').val()
              },
              'flash': {
                'notice': "<%= I18n.t("notices.password_reset") %>"
              }
            },
            success: function(data) {
              activeInfoWindow.setContent(data);
              $('#user_existing').click();
            }
          });
        }
      });
    }
    return false;
  });
  
  
  
  
  
  
  
  
  
  $('#adoption_form').live('submit', function() {
    var submitButton = $("#adoption_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'POST',
      url: '/things.json',
      data: {
        'id': $('#thing_id').val(),
        'commit': submitButton.val(),
        'utf8': '✓',
        'authenticity_token': $('#adoption_form input[name="authenticity_token"]').val(),
        '_method': 'put',
        'thing': {
          'user_id': $('#thing_user_id').val(),
          'name': $('#thing_name').val()
        }
      },
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        $.ajax({
          type: 'GET',
          url: '/info_window',
          data: {
            'thing_id': activeObjectId,
            'flash': {
              'notice': "<%= I18n.t("notices.adopted", :thing => I18n.t("defaults.thing")) %>"
            }
          },
          success: function(data) {
            activeInfoWindow.setContent(data);
            image = new google.maps.MarkerImage('<%= image_path 'markers/green.png' %>',
              new google.maps.Size(27.0, 37.0),
              new google.maps.Point(0, 0),
              new google.maps.Point(13.0, 18.0)
            );
            activeMarker.setIcon(image);
            activeMarker.setAnimation(google.maps.Animation.BOUNCE);
          }
        });
      }
    });
    return false;
  });
  
  $('#abandon_form').live('submit', function() {
    var answer = window.confirm("Are you sure you want to abandon this <%= I18n.t("defaults.thing") %>?")
    if(answer) {
      var submitButton = $("#abandon_form input[type='submit']");
      $(submitButton).attr("disabled", true);
      $.ajax({
        type: 'POST',
        url: '/things.json',
        data: {
          'id': $('#thing_id').val(),
          'commit': submitButton.val(),
          'utf8': '✓',
          'authenticity_token': $('#abandon_form input[name="authenticity_token"]').val(),
          '_method': 'put',
          'thing': {
            'user_id': $('#thing_user_id').val(),
            'name': $('#thing_name').val()
          }
        },
        beforeSend: function() {
          $('#info_window').hide();
          $('#loader').show();
        },
        error: function(jqXHR) {
          $('#loader').hide();
          $('#info_window').show();
          $(submitButton).attr("disabled", false);
        },
        success: function(data) {
          $.ajax({
            type: 'GET',
            url: '/info_window',
            data: {
              'thing_id': activeObjectId,
              'flash': {
                'notice': "<%= I18n.t("notices.abandoned", :thing => I18n.t("defaults.thing").capitalize) %>"
              }
            },
            success: function(data) {
              activeInfoWindow.setContent(data);
              image = new google.maps.MarkerImage('<%= image_path 'markers/red.png' %>',
                new google.maps.Size(27.0, 37.0),
                new google.maps.Point(0, 0),
                new google.maps.Point(13.0, 18.0)
              );
              activeMarker.setIcon(image);
              activeMarker.setAnimation(null);
            }
          });
        }
      });
    }
    return false;
  });
  
  $('#edit_profile_form').live('submit', function() {
    var submitButton = $("#edit_profile_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'GET',
      url: '/users/edit',
      data: {
        'commit': submitButton.val(),
        'utf8': '✓',
        'authenticity_token': $('#edit_profile_form input[name="authenticity_token"]').val()
      },
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        activeInfoWindow.setContent(data);
      }
    });
    return false;
  });
  
  $('#edit_form').live('submit', function() {
    var submitButton = $("#edit_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    var errors = []
    if(!/[\w\.%\+\]+@[\w\]+\.+[\w]{2,}/.test($('#user_email').val())) {
      errors.push($('#user_email'));
      $('#user_email_label').addClass('error', 500);
      $('#user_email').addClass('error', 500);
    } else {
      $('#user_email_label').removeClass('error');
      $('#user_email').removeClass('error');
    }
    if($('#user_name').val() === '') {
      errors.push($('#user_name'));
      $('#user_name_label').addClass('error', 500);
      $('#user_name').addClass('error', 500);
    } else {
      $('#user_name_label').removeClass('error');
      $('#user_name').removeClass('error');
    }
    if($('#user_password').val() && ($('#user_password').val().length < 6 || $('#user_password').val().length > 20)) {
      errors.push($('#user_password'));
      $('#user_password_label').addClass('error', 500);
      $('#user_password').addClass('error', 500);
    } else {
      $('#user_password_label').removeClass('error');
      $('#user_password').removeClass('error');
    }
    if($('#user_current_password').val().length < 6 || $('#user_current_password').val().length > 20) {
      errors.push($('#user_current_password'));
      $('#user_current_password_label').addClass('error', 500);
      $('#user_current_password').addClass('error', 500);
    } else {
      $('#user_current_password_label').removeClass('error');
      $('#user_current_password').removeClass('error');
    }
    if(errors.length > 0) {
      $(submitButton).attr("disabled", false);
      errors[0].focus();
    } else {
      $.ajax({
        type: 'POST',
        url: '/users.json',
        data: {
          'id': $('#id').val(),
          'thing_id': activeObjectId,
          'commit': submitButton.val(),
          'utf8': '✓',
          'authenticity_token': $('#edit_form input[name="authenticity_token"]').val(),
          '_method': 'put',
          'user': {
            'email': $('#user_email').val(),
            'name': $('#user_name').val(),
            'organization': $('#user_organization').val(),
            'voice_number': $('#user_voice_number').val(),
            'sms_number': $('#user_sms_number').val(),
            'password': $('#user_password').val(),
            'password_confirmation': $('#user_password').val(),
            'current_password': $('#user_current_password').val()
          }
        },
        beforeSend: function() {
          $('#info_window').hide();
          $('#loader').show();
        },
        error: function(jqXHR) {
          data = $.parseJSON(jqXHR.responseText);
          $('#loader').hide();
          $('#info_window').show();
          $(submitButton).attr("disabled", false);
          if(data.errors.email) {
            errors.push($('#user_email'));
            $('#user_email_label').addClass('error', 500);
            $('#user_email').addClass('error', 500);
          }
          if(data.errors.name) {
            errors.push($('#user_name'));
            $('#user_name_label').addClass('error', 500);
            $('#user_name').addClass('error', 500);
          }
          if(data.errors.organization) {
            errors.push($('#user_organization'));
            $('#user_organization_label').addClass('error', 500);
            $('#user_organization').addClass('error', 500);
          }
          if(data.errors.voice_number) {
            errors.push($('#user_voice_number'));
            $('#user_voice_number_label').addClass('error', 500);
            $('#user_voice_number').addClass('error', 500);
          }
          if(data.errors.sms_number) {
            errors.push($('#user_sms_number'));
            $('#user_sms_number_label').addClass('error', 500);
            $('#user_sms_number').addClass('error', 500);
          }
          if(data.errors.password) {
            errors.push($('#user_password'));
            $('#user_password_label').addClass('error', 500);
            $('#user_password').addClass('error', 500);
          }
          if(data.errors.current_password) {
            errors.push($('#user_current_password'));
            $('#user_current_password_label').addClass('error', 500);
            $('#user_current_password').addClass('error', 500);
          }
          errors[0].focus();
        },
        success: function(data) {
          activeInfoWindow.setContent(data);
        }
      });
    }
    return false;
  });
  
  $('#sign_out_form').live('submit', function() {
    var submitButton = $("#sign_out_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'GET',
      url: '/users/sign_out.json',
      data: {
        'commit': submitButton.val(),
        'utf8': '✓',
        'authenticity_token': $('#sign_out_form input[name="authenticity_token"]').val()
      },
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        $.ajax({
          type: 'GET',
          url: '/info_window',
          data: {
            'thing_id': activeObjectId,
            'flash': {
              'notice': "<%= I18n.t("notices.signed_out") %>"
            }
          },
          success: function(data) {
            activeInfoWindow.setContent(data);
          }
        });
      }
    });
    return false;
  });
  
  $('#back_form').live('submit', function() {
    var submitButton = $("#back_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'GET',
      url: '/info_window',
      data: {
        'commit': submitButton.val(),
        'utf8': '✓',
        'authenticity_token': $('#back_form input[name="authenticity_token"]').val(),
        'thing_id': activeObjectId
      },
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        activeInfoWindow.setContent(data);
      }
    });
    return false;
  });
  
  $('#reminder_form').live('submit', function() {
    var submitButton = $("#reminder_form input[type='submit']");
    $(submitButton).attr("disabled", true);
    $.ajax({
      type: 'POST',
      url: '/reminders.json',
      data: {
        'commit': submitButton.val(),
        'utf8': '✓',
        'authenticity_token': $('#sign_out_form input[name="authenticity_token"]').val(),
        'reminder': {
          'from_user_id': $('#reminder_from_user_id').val(),
          'to_user_id': $('#reminder_to_user_id').val(),
          'thing_id': activeObjectId
        }
      },
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
        $(submitButton).attr("disabled", false);
      },
      success: function(data) {
        $.ajax({
          type: 'GET',
          url: '/info_window',
          data: {
            'thing_id': activeObjectId,
            'flash': {
              'notice': "<%= I18n.t("notices.reminder_sent") %>"
            }
          },
          success: function(data) {
            activeInfoWindow.setContent(data);
          }
        });
      }
    });
    return false;
  });
  
  
  
  function bindInfoWindowLink(id, url, type, data, options) {
    $('#'+id).live('click', function() {
      $.ajax({
        type: type,
        url: url,
        data: $.extend(true, {'id': activeObjectId,
                              'utf8': '✓',
                              'authenticity_token': AUTH_TOKEN},
                              data),
        beforeSend: function() {
          if (options['showIW'] == true) {
            isWindowOpen = true;
            activeInfoWindow.open(map);
            showInfoWindow();
          } else {
            hideInfoWindow();
            showSpinner();
          }
        },
        error: function(jqXHR) {
          hideSpinner();
          showInfoWindow;
        },
        success: function(data) {
          activeInfoWindow.setContent(data);
        }
      });
      return false;
    });
  }
  
  
  
  
  
  $('#tos_link').live('click', function() {
    $.ajax({
      type: 'GET',
      url: '/tos',
      beforeSend: function() {
        $('#info_window').hide();
        $('#loader').show();
      },
      error: function(jqXHR) {
        $('#loader').hide();
        $('#info_window').show();
      },
      success: function(data) {
        activeInfoWindow.setContent(data);
      }
    });
    return false;
  });
  
  $('#notice').live('click', function() {
    $(this).fadeOut('slow');
  });
  
  $('#error').live('click', function() {
    $(this).fadeOut('slow');
  });
  
  function markError(i, e) {
    e.push(i);
    $(i).addClass('error', 500).prevAll('label:first').addClass('error', 500);
  }
  
  function unmarkError(i) {
    $(i).removeClass('error').prevAll('label:first').removeClass('error');
  }
  
  
});
